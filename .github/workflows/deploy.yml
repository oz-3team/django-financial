name: Deploy to EC2 via Docker Compose

on:
  push:
    branches:
      - release

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY_DAMON }}

      - name: Deploy on EC2
        run: |
          ssh -t -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            APP_DIR=~/django-financial
            STATIC_DIR=$APP_DIR/staticfiles
            MEDIA_DIR=$APP_DIR/media
            USER=www-data

            # Î∞îÎ°ú APP_DIRÎ°ú Ïù¥Îèô
            cd $APP_DIR || { echo "‚ùå App directory not found"; exit 1; }

            echo "üõ† Ensuring static/media directories exist..."
            # ÏÉùÏÑ± ÏãúÎèÑ Ïã§Ìå®(Ïù¥ÎØ∏ ÏûàÏùå)Ìï¥ÎèÑ ÎÑòÏñ¥Í∞ê
            mkdir -p $STATIC_DIR
            mkdir -p $MEDIA_DIR

            echo "üîë Setting directory permissions..."
            #nginx Í∂åÌïú ÏÑ§Ï†ï
            sudo chown -R ubuntu:ubuntu $STATIC_DIR $MEDIA_DIR
            sudo chmod -R 755 $STATIC_DIR $MEDIA_DIR

            # ÏÉÅÏúÑ ÎîîÎ†âÌÑ∞Î¶¨ Ï†ëÍ∑º Í∂åÌïú ( Í±∞Ïùò Î™®Îì† Í≤ΩÎ°úÏóê Îã§ Í∂åÌïúÏ£ºÍ∏∞)
            sudo chmod o+x /home/ubuntu
            sudo chmod o+rx $APP_DIR
            sudo chmod -R o+rX $APP_DIR/*

            echo "üì• Fetching latest code..."
            # git ÏµúÏã† Ïª§Î∞ãÏÉÅÌÉúÎ°ú
            BRANCH=release
            git fetch origin $BRANCH
            git reset --hard origin/$BRANCH

            echo "üê≥ Restarting Docker Compose..."
            # Ïö©ÎüâÏúºÎ°ú Ïù∏Ìïú CD Ïò§Î•ò Í∑ÄÏ∞ÆÏïÑÏÑú ÌîÑÎ£¨ Îã§Ïãú Î≥µÍ∑Ä
            docker-compose down --remove-orphans
            
            docker system prune -f
            docker image prune -f
            docker container prune -f
            
            docker-compose up -d --build

            echo "‚è±Ô∏è Waiting for containers..."
            sleep 10

            echo "üì¶ Collecting static files..."
            docker-compose exec web python manage.py collectstatic --noinput

            echo "üåê Reloading Nginx..."
            if command -v nginx >/dev/null 2>&1; then
              sudo nginx -t && sudo systemctl reload nginx || echo "‚ö†Ô∏è Nginx reload failed"
            fi

            echo "‚úÖ Deployment completed!"
          EOF
      

      - name: Post-deployment verification
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            'cd ~/django-financial && docker-compose ps && echo "‚úÖ Verification completed"'
